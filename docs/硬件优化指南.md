# SonjayOS 硬件优化指南

## 概述

本文档详细介绍了如何为SonjayOS配置和优化AMD Ryzen 7 8845H处理器和Radeon 780M显卡，以实现最佳性能。

## 目标硬件规格

### CPU: AMD Ryzen 7 8845H
- **核心数**: 8核心16线程
- **基础频率**: 3.8 GHz
- **最大加速频率**: 5.1 GHz
- **缓存**: 24 MB L3缓存
- **TDP**: 45W
- **架构**: Zen 4

### GPU: Radeon 780M
- **架构**: RDNA 3
- **计算单元**: 12个
- **显存**: 共享系统内存
- **内存带宽**: 最高68.3 GB/s
- **ROCm支持**: 是

### 内存
- **总容量**: 32 GB
- **可用容量**: 27.8 GB
- **类型**: DDR5
- **频率**: 5600 MHz

## 优化配置

### 1. CPU优化

#### 性能模式设置
```bash
# 设置CPU性能模式
echo 'performance' | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# 启用CPU Boost
echo 1 | sudo tee /sys/devices/system/cpu/cpufreq/boost
```

#### 电源管理优化
```bash
# 设置电源模式为性能
sudo systemctl set-default multi-user.target
sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target
```

### 2. GPU优化

#### ROCm安装和配置
```bash
# 安装ROCm
wget https://repo.radeon.com/amdgpu-install/5.7/ubuntu/jammy/amdgpu-install_5.7.50700-1_all.deb
sudo apt install ./amdgpu-install_5.7.50700-1_all.deb
sudo amdgpu-install --usecase=rocm

# 配置环境变量
echo 'export PATH=$PATH:/opt/rocm/bin' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/rocm/lib' >> ~/.bashrc
echo 'export HIP_PLATFORM=amd' >> ~/.bashrc
echo 'export HSA_OVERRIDE_GFX_VERSION=10.3.0' >> ~/.bashrc
```

#### GPU性能调优
```bash
# 设置GPU性能模式
echo 'performance' | sudo tee /sys/class/drm/card*/device/power_dpm_force_performance_level

# 优化GPU内存
echo 'gpu_mem=128' | sudo tee -a /boot/firmware/config.txt
```

### 3. 内存优化

#### 内存管理优化
```bash
# 优化内存管理参数
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
echo 'vm.vfs_cache_pressure=50' | sudo tee -a /etc/sysctl.conf
echo 'vm.dirty_ratio=15' | sudo tee -a /etc/sysctl.conf
echo 'vm.dirty_background_ratio=5' | sudo tee -a /etc/sysctl.conf

# 应用配置
sudo sysctl -p
```

### 4. AI模型优化

#### PyTorch ROCm支持
```bash
# 安装PyTorch with ROCm支持
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/rocm5.6
```

#### 模型配置优化
```json
{
    "llama": {
        "use_gpu": true,
        "rocm_optimization": true,
        "mixed_precision": true,
        "memory_efficient": true
    },
    "whisper": {
        "use_gpu": true,
        "rocm_optimization": true,
        "real_time_processing": true
    }
}
```

## 性能监控

### 系统监控脚本
```bash
# 运行系统监控
python3 scripts/monitor/system_monitor.py
```

### 关键性能指标
- **启动时间**: < 30秒
- **AI推理延迟**: < 1秒
- **空闲CPU使用率**: < 20%
- **空闲内存使用率**: < 20%
- **GPU利用率**: > 80%

## 故障排除

### 常见问题

#### 1. ROCm安装失败
```bash
# 检查GPU支持
lspci | grep -i amd
/opt/rocm/bin/rocminfo
```

#### 2. GPU温度过高
```bash
# 检查GPU温度
sensors
# 调整风扇曲线
echo 'manual' | sudo tee /sys/class/drm/card*/device/power_dpm_force_performance_level
```

#### 3. 内存不足
```bash
# 检查内存使用
free -h
# 清理缓存
sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches
```

## 最佳实践

### 1. 系统配置
- 使用SSD存储系统文件
- 定期清理临时文件
- 监控系统温度
- 保持系统更新

### 2. AI模型使用
- 使用混合精度训练
- 启用内存池
- 合理设置批处理大小
- 监控GPU利用率

### 3. 性能调优
- 定期运行性能测试
- 监控系统资源使用
- 根据负载调整配置
- 备份重要配置

## 性能测试

### 基准测试脚本
```bash
# 运行性能测试
python3 scripts/benchmark/performance_test.py
```

### 测试项目
- CPU性能测试
- GPU性能测试
- 内存带宽测试
- AI模型推理测试
- 系统启动时间测试

## 结论

通过以上优化配置，SonjayOS可以在AMD Ryzen 7 8845H和Radeon 780M硬件上实现最佳性能，为AI应用提供强大的计算支持。

定期监控系统性能并根据实际使用情况调整配置，可以确保系统始终保持最佳状态。
